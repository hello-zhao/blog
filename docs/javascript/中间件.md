```js
class Koa {
  middlewares = []

  use(pipe) {
    this.middlewares.push(pipe)
  }

  composeMiddlewares(middlewares) {
    return function(ctx) {
      let index = 0
      function dispatch (index) {
        const fn = middlewares[index]
        if (!fn) return Promise.resolve()
        return Promise.resolve(
          fn(ctx, () => dispatch(index + 1))
        )
      }
      return dispatch(index);
    }
  }

  run({req}) {
    const composed = this.composeMiddlewares(this.middlewares)
    const ctx = {req, res: null}
    return composed(ctx)
  }
}

const app = new Koa();

const middleware1 =  function () {
  return async function ( ctx, next ) {
    console.log(1);
    await next()
    console.log('demo:' + ctx.demo)
    console.log(2);
  }
}
const middleware2 =  function () {
  return async function ( ctx, next ) {
    console.log(3);
    ctx.demo = 2
    await next()
    console.log(4);
  }
}

app.use(middleware1());
app.use(middleware2());
app.use(async (ctx, next) => {
    console.log(5);
    await next();
    console.log(6);
});

app.run({req: {test: 123}})
```
